#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
RESUME_DIR="$REPO_ROOT/resume"
BUILD_DATE=$(date -u +"%Y-%m-%d")

SHARED_CSS='
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: #1f2328;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    h1 { margin-top: 0; font-size: 2rem; }
    h2 { font-size: 1.4rem; border-bottom: 1px solid #d1d9e0; padding-bottom: 0.3rem; margin-top: 1.5rem; }
    h3 { font-size: 1.15rem; margin-top: 1.25rem; }
    h4 { margin-top: 1.5rem; }
    hr { border: none; border-top: 1px solid #d1d9e0; margin: 1.5rem 0; }
    ul { padding-left: 1.5rem; }
    li { margin-bottom: 0.25rem; }
    code { background: #f6f8fa; padding: 0.15rem 0.35rem; border-radius: 4px; font-size: 0.9em; }
    a { color: #0969da; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .nav-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #d1d9e0;
    }
    .nav-bar a {
      font-size: 0.875rem;
      font-weight: 500;
    }
    .nav-bar .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.9rem;
      color: #1f2328;
      background: #f6f8fa;
      border: 1px solid #d1d9e0;
      border-radius: 6px;
    }
    .nav-bar .btn:hover {
      background: #eaeef2;
      text-decoration: none;
    }
'

EXTERNAL_LINKS_SCRIPT='<script>document.querySelectorAll("a[href]").forEach(function(a){if(a.hostname&&a.hostname!==location.hostname)a.target="_blank"});</script>'

# --- Build index.html ---

INDEX_INPUT="$REPO_ROOT/index.md"
INDEX_OUTPUT="$REPO_ROOT/index.html"

if [[ ! -f "$INDEX_INPUT" ]]; then
  echo "error: $INDEX_INPUT not found" >&2
  exit 1
fi

echo "Building index.html..."
INDEX_BODY=$(pandoc "$INDEX_INPUT" --from gfm --to html)

cat > "$INDEX_OUTPUT" << HTMLEOF
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Terry Horner — engineering leader with 20+ years building search infrastructure, distributed systems, and startups. Built GitHub Code Search and Copilot's retrieval systems.">
  <title>Terry Horner: tl;dr</title>
  <style>$SHARED_CSS</style>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ProfilePage",
    "mainEntity": {
      "@type": "Person",
      "name": "Terry Horner",
      "jobTitle": "Staff Engineering Manager",
      "worksFor": {
        "@type": "Organization",
        "name": "GitHub"
      },
      "url": "https://terrhorn.github.io/",
      "sameAs": [
        "https://github.com/terrhorn",
        "https://linkedin.com/in/terryhorner",
        "https://twitter.com/terrhorn"
      ],
      "knowsAbout": ["search infrastructure", "distributed systems", "AI infrastructure", "engineering leadership", "RAG systems"]
    }
  }
  </script>
</head>
<body>
  <main>
$INDEX_BODY
  </main>
$EXTERNAL_LINKS_SCRIPT
</body>
</html>
HTMLEOF

echo "Done → $INDEX_OUTPUT"

# --- Build user-manual.html ---

MANUAL_INPUT="$REPO_ROOT/user-manual.md"
MANUAL_OUTPUT="$REPO_ROOT/user-manual.html"

if [[ ! -f "$MANUAL_INPUT" ]]; then
  echo "error: $MANUAL_INPUT not found" >&2
  exit 1
fi

echo "Building user-manual.html..."
MANUAL_BODY=$(pandoc "$MANUAL_INPUT" --from gfm --to html)

cat > "$MANUAL_OUTPUT" << HTMLEOF
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Terry Horner's user manual — how he works, communication preferences, strengths, quirks, and leadership approach.">
  <title>Terry Horner: User Manual</title>
  <style>$SHARED_CSS</style>
</head>
<body>
  <nav class="nav-bar">
    <a href="index.html">&larr; About Me</a>
  </nav>
  <main>
$MANUAL_BODY
  </main>
$EXTERNAL_LINKS_SCRIPT
</body>
</html>
HTMLEOF

echo "Done → $MANUAL_OUTPUT"

# --- Build resume/index.html + PDF ---

RESUME_INPUT="$RESUME_DIR/terry-horner-resume.md"
RESUME_HTML="$RESUME_DIR/index.html"
RESUME_PDF="$RESUME_DIR/terry-horner-resume.pdf"

if [[ ! -f "$RESUME_INPUT" ]]; then
  echo "error: $RESUME_INPUT not found" >&2
  exit 1
fi

mkdir -p "$RESUME_DIR"

echo "Building resume PDF..."
npx --yes md-to-pdf "$RESUME_INPUT" \
  --pdf-options '{"margin":{"top":"10mm","bottom":"10mm","left":"15mm","right":"15mm"}}' \
  --css 'body { margin: 0; padding: 0; } h1:first-child { margin-top: 0; padding-top: 0; } *:first-child { margin-top: 0; }'

echo "Building resume HTML..."
RESUME_BODY=$(pandoc "$RESUME_INPUT" --from gfm --to html)

cat > "$RESUME_HTML" << HTMLEOF
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Terry Horner's resume — Staff Engineering Manager at GitHub, built Code Search serving 100M+ developers, 20+ years in distributed systems and engineering leadership.">
  <title>Terry Horner — Resume</title>
  <style>$SHARED_CSS</style>
</head>
<body>
  <nav class="nav-bar">
    <a href="../index.html">&larr; About Me</a>
    <a class="btn" href="terry-horner-resume.pdf" download>Download PDF</a>
  </nav>
  <main>
$RESUME_BODY
  </main>
$EXTERNAL_LINKS_SCRIPT
</body>
</html>
HTMLEOF

echo "Done → $RESUME_HTML"
echo "Done → $RESUME_PDF"

# --- Generate llms.txt ---

echo "Generating llms.txt..."
cat > "$REPO_ROOT/llms.txt" << 'LLMSEOF'
# Terry Horner

> Engineering leader with 20+ years building search infrastructure, distributed
> systems, and high-performing teams. Built the search and retrieval systems at
> GitHub powering Code Search and Copilot.

- [About](https://terrhorn.github.io/): Career overview, background, and links
- [Resume](https://terrhorn.github.io/resume/): Professional history, skills, and experience
- [User Manual](https://terrhorn.github.io/user-manual.html): How I work, communication style, and leadership approach

## Elsewhere

- [GitHub](https://github.com/terrhorn)
- [LinkedIn](https://linkedin.com/in/terryhorner)
- [Twitter](https://twitter.com/terrhorn)
LLMSEOF

echo "Done → $REPO_ROOT/llms.txt"

# --- Generate llms-full.txt ---

echo "Generating llms-full.txt..."
{
  cat "$REPO_ROOT/index.md"
  echo ""
  echo "---"
  echo ""
  cat "$REPO_ROOT/user-manual.md"
  echo ""
  echo "---"
  echo ""
  cat "$RESUME_INPUT"
} > "$REPO_ROOT/llms-full.txt"

echo "Done → $REPO_ROOT/llms-full.txt"

# --- Generate robots.txt ---

echo "Generating robots.txt..."
cat > "$REPO_ROOT/robots.txt" << 'ROBOTSEOF'
User-agent: *
Allow: /

Sitemap: https://terrhorn.github.io/sitemap.xml
ROBOTSEOF

echo "Done → $REPO_ROOT/robots.txt"

# --- Generate sitemap.xml ---

echo "Generating sitemap.xml..."
cat > "$REPO_ROOT/sitemap.xml" << SITEMAPEOF
<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <url>
    <loc>https://terrhorn.github.io/</loc>
    <lastmod>$BUILD_DATE</lastmod>
  </url>
  <url>
    <loc>https://terrhorn.github.io/resume/</loc>
    <lastmod>$BUILD_DATE</lastmod>
  </url>
  <url>
    <loc>https://terrhorn.github.io/user-manual.html</loc>
    <lastmod>$BUILD_DATE</lastmod>
  </url>
  <url>
    <loc>https://terrhorn.github.io/llms.txt</loc>
    <lastmod>$BUILD_DATE</lastmod>
  </url>
  <url>
    <loc>https://terrhorn.github.io/llms-full.txt</loc>
    <lastmod>$BUILD_DATE</lastmod>
  </url>
</urlset>
SITEMAPEOF

echo "Done → $REPO_ROOT/sitemap.xml"
